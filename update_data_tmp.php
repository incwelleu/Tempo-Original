<?php
require_once("rpcl/rpcl.inc.php");
require_once("include/functions.php");
require_once("include/acceso.php");

//Includes
use_unit("forms.inc.php");
use_unit("extctrls.inc.php");
use_unit("stdctrls.inc.php");
use_unit("buttons.inc.php");

//Class definition
class Unit1 extends Page
{
    public $btnUpdateTable = null;
    public $table_update = null;
    public $lbUpdateTable = null;
    public $btnModelo360 = null;
    public $btnUpdateTaxIdent = null;
    public $btnUpdateCompany = null;
    public $btnUpdateTable1 = null;
    public $btnVirtualFile = null;
    public $btnClientProvider = null;
    function btnUpdateTaxIdentClick($sender, $params)
    {
      $this->Update_client();
      $this->Update_provider();
    }


    function Update_client()
    {
      Global $connectionDB;
      $caracter = array("\\", "¨", "º", "~", "#", "@", "|", "!", "·", "$", "%", "&", "?","'", "¡", "¿", "[", "^", "`", "]", "+", "}", "{", "¨", "´", ">", "<", ";", ":", "(", ")", ".", " ","-", "_");

      $sql = "SELECT * FROM company_client";

      $query = New Query();
      $query->Database = $connectionDB->DbConnection;
      $query->SQL = $sql;
      $query->LimitStart = -1;
      $query->LimitCount = -1;
      $query->open();

      While (!$query->EOF){
        $tax_ident = sw_clean_caracter_tax_ident($query->Fields['tax_ident']);
        $company_client_id = $query->Fields['company_client_id'];

        $sql_client = "UPDATE company_client
                       SET tax_ident = '{$tax_ident}'
                       WHERE company_client_id = {$company_client_id}";

        $sql = "UPDATE invoice_issued
                SET tax_ident = '{$tax_ident}'
                WHERE company_client_id = {$company_client_id}";

        $connectionDB->DbConnection->BeginTrans();
        $connectionDB->DbConnection->execute($sql_client);
        $connectionDB->DbConnection->execute($sql);
        $connectionDB->DbConnection->CompleteTrans();
        $query->next();
      }
    }

    function Update_provider()
    {
      Global $connectionDB;
      $caracter = array("\\", "¨", "º", "~", "#", "@", "|", "!", "·", "$", "%", "&", "?","'", "¡", "¿", "[", "^", "`", "]", "+", "}", "{", "¨", "´", ">", "<", ";", ":", "(", ")", ".", " ","-", "_");

      $sql = "SELECT * FROM company_provider";

      $query = New Query();
      $query->Database = $connectionDB->DbConnection;
      $query->SQL = $sql;
      $query->LimitStart = -1;
      $query->LimitCount = -1;
      $query->open();

      While (!$query->EOF){
        $tax_ident = sw_clean_caracter_tax_ident($query->Fields['tax_ident']);
        $company_provider_id = $query->Fields['company_provider_id'];

        $sql_provider = "UPDATE company_provider
                       SET tax_ident = '{$tax_ident}'
                       WHERE company_provider_id = {$company_provider_id}";

        $sql = "UPDATE invoice_received
                SET tax_ident = '{$tax_ident}'
                WHERE company_provider_id = {$company_provider_id}";

        $connectionDB->DbConnection->BeginTrans();
        $connectionDB->DbConnection->execute($sql_provider);
        $connectionDB->DbConnection->execute($sql);
        $connectionDB->DbConnection->CompleteTrans();
        $query->next();
      }
    }

    function btnUpdateCompanyClick($sender, $params)
    {
      $this->Update_company();
    }

    function Update_company()
    {
      Global $connectionDB;

      $search =  array('\n\r', chr(13));

      $replace = array('<br/>', '');

      $sql = "SELECT * FROM company_dh ORDER BY T01_01_Company_Name ";

      $query = New Query();
      $query->Database = $connectionDB->DbConnection;
      $query->SQL = $sql;
      $query->LimitStart = -1;
      $query->LimitCount = -1;
      $query->open();

      While (!$query->EOF){
        $record = $query->fieldbuffer;
        foreach ($record as $key => $value){
//          $value = str_replace($search, $replace, $value);
          if (!mb_check_encoding($value, 'UTF-8')) {
            $value = utf8_encode(trim($value));
          }
          $record[$key] =  $value;
        }

        sw_update_table("company_dh", $record, "T01_PK = {$record['T01_PK']}");
        $query->next();
      }
    }


    function btnUpdateTable1Click($sender, $params)
    {
      $this->Update_UTF8('cnae_code', 'cnae_code_id');
      $this->Update_UTF8('activity_code', 'activity_code_id');
      $this->Update_UTF8('tax_model', 'tax_model_id');
      $this->Update_UTF8('payment_method', 'payment_method_id');
      $this->Update_UTF8('street_type', 'street_type_id');
      $this->Update_UTF8('country', 'country_id');
      $this->Update_UTF8('tax_regime', 'tax_regime_id');
      $this->Update_UTF8('tax_type_key', 'tax_type_key_id');
      $this->Update_UTF8('service', 'service_id');
      $this->Update_UTF8('invoice_issued', 'invoice_issued_id');
      $this->Update_UTF8('line_item', 'line_item_id');
    }

    function Update_UTF8($table, $key = '')
    {
      Global $connectionDB;

      $sql = "SELECT * FROM {$table} ";

      $query = New Query();
      $query->Database = $connectionDB->DbConnection;
      $query->SQL = $sql;
      $query->LimitStart = -1;
      $query->LimitCount = -1;
      $query->open();

      $key = $key == '' ? $table . "_id" : $key;

      While (!$query->EOF){
        $record = $query->fieldbuffer;
        foreach ($record as $field => $value){
          if (!mb_check_encoding($value, 'UTF-8')) {
            $value = utf8_encode(trim($value));
          }
          $record[$field] =  $value;
        }
        $where = "{$key} = '" . $record[$key] . "'";
        sw_update_table($table, $record, $where);
        $query->next();
      }
    }


    function btnModelo360Click($sender, $params)
    {
      $register01 = "<T360010> 00010002ES201200                                 B76535186STRONG WEBER SL                                                                                                              TVERA@STRONGABOGADOS.COM                                                                            922244244      CALLEDOCTOR J NAVEIRAS                                 NUM00022            2                                                                           38004SANTA CRUZ DE TENERIFE        38                                                                                                                                                                                                                            0000000000                              00000                                0  386203                            8220                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               00000                                                                                        00000                                                                                                                                                                                                                                                            0000000000                              00000                                000000000093665EUR00018000000101201231122012000000201200000STRONG WEBER, SL         AES3521002169820200278227          CAIXESBBXXXEUR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </T360010>";

                   //12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901
      $register02 = "<T360020> 000011P  E228412                                           0506201210.       ESMATERIAL OFICINA                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                00000000000141000000000000025401800000000000000254EUR0ESESB61195202                                                        P.C. GREEN                                                                                                                   C/SEPULVEDA, 178                                                                                                                                                   ES000021P  L120204001                                        0606201210.       ESGASTOS NOTARIA                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  00000000000141000000000000025401800000000000000254EUR0ESES19461050Z                                                        FRANCISCO PALOP TORDERA                                                                                                      PASEO DE GRACIA, 27, 2,2, BARCELONA                                                                                                                 934882233      ES                                                                                                                                                                                    </T360020>";
                    "<T360020>C000031P  9020114106                                        2106201210.       ESMATERIAL OFICINA                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                00000000000151700000000000027301800000000000000273EUR0ESESF08226714                                                        ABACUS                                                                                                                       CORSEGA 269, BARCELONA                                                                                                                                             ES000041P  5189                                              2506201210.       ESSERVICIOS DE VIGILANCIA PARA LA SALUD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           00000000002500000000000000450000800000000000004500EUR0ESESB62643978                                                        GABINETE                                                                                                                     CALLE MELCIOR DE PALAU, 135, LOCAL 4, BARCELONA                                                                                                     932412256      ES                                                                                                                                                                                    </T360020>";
                    "<T360020>C000051P  A46221                                            3006201210.       ESMENSAJERIA                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      00000000001480200000000000266401800000000000002664EUR0ESESB60705225                                                        MISSIVA SERVEIS, SL                                                                                                          REGAS, 23, BJS., LOCAL 1, BARCELONA                                                                                                                 934186611      ES000061P  7573624                                           0606201210.       ESMATERIAL DE OFICINA                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             00000000002436400000000000438601800000000000004386EUR0ESESB80441306                                                        OFFICE DEPOT, SL                                                                                                             RTDA RENE DESCARTES, S/N MADRID                                                                                                                                    ES                                                                                                                                                                                    </T360020>";
                    "<T360020>C000071P  0120000444                                        3105201210.       ESASESORAMIENTO LABORAL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           00000000014750000000000002655001800000000000026550EUR0ESES26145761M                                                        LUIS SANCHEZ SANCHEZ                                                                                                         MURILLO 11, BAJO, LINARES, JAEN                                                                                                                                    ES000081P  035502012CE                                       2505201210.       ESSERVICIOS DE VALORACIONES DE VIVIENDAS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          00000000004668000000000000840201800000000000008402EUR0ESESA03525508                                                        EUROVALORACIONES SA                                                                                                          PLAZA DE LA CONSTITUCION 2 SAN JUAN DE ALICANTE                                                                                                     902100367      ES                                                                                                                                                                                    </T360020>";

    }

    function btnVirtualFileClick($sender, $params)
    {
      Global $connectionDB;

      $search =  array('\n\r', chr(13));

      $replace = array('<br/>', '');

      $sql = "SELECT * FROM virtual_file Where description_es != ''";

      $query = New Query();
      $query->Database = $connectionDB->DbConnection;
      $query->SQL = $sql;
      $query->LimitStart = -1;
      $query->LimitCount = -1;
      $query->open();

      While (!$query->EOF){
        $record = $query->fieldbuffer;
        foreach ($record as $key => $value){
          if (!mb_check_encoding($value, 'UTF-8')) {
            $value = utf8_encode(trim($value));
          }
          $record[$key] =  $value;
        }

        sw_update_table("virtual_file", $record, "nodo_id = {$record['nodo_id']}");
        $query->next();
      }
    }

    function btnClientProviderClick($sender, $params)
    {
      $this->Update_UTF8('company_client', 'company_client_id');
      $this->Update_UTF8('company_provider', 'company_provider_id');
    }

    function btnUpdateTableClick($sender, $params)
    {
      $this->Update_UTF8($this->table_update->Text);
    }


}

global $application;

global $Unit1;

//Creates the form
$Unit1=new Unit1($application);

//Read from resource file
$Unit1->loadResource(__FILE__);

//Shows the form
$Unit1->show();

?>